<tool id="iReport" name="iReport" version="1">

	<!--  Note to Galaxy Admins:
	This wrapper contains one hidden parameter with hardcoded server location, this is currently needed for dalliance genome browser to function correctly,
	please change this value as needed! (see below for parameter: <param name="localhost" type="hidden" value="https://bioninf-galaxian.erasmusmc.nl"/>)
	-->

	<macros>
		<import>macros.xml</import>
	</macros>

	<description> create an HTML report </description>

        <requirements>
		<requirement type="set_environment">REPOSITORY_PATH</requirement>
	</requirements>

	<command interpreter="bash">
		iReport.py
			$main
			--htmlDir $report.files_path
			> $report
	</command>
	<configfiles>
		<configfile name="main">
		<![CDATA[
#def b64($value)
#set $out = str($value).encode('base64').replace('\n','')
$out
#end def

		<iReport toolPath="$__tool_dir__" minWidth="${minWidth}" coverImage="$b64($coverimage)" label="$b64($label)">
			#for $i, $t in enumerate($tabs)
			<tab title="$b64($t.tabtitle)">
				#for $j, $u in enumerate($t.content)
					#if $u.filetype.itemtype == "image"
					<image
						obj="${u.filetype.item}"
						break="${u.filetype.break}"
						zoom="${u.filetype.zoomlevel}"
						zoomEnable="${u.filetype.zoomenable}"
						align="${u.filetype.align}"
						/>
					#else if $u.filetype.itemtype == "table"
					<table
						obj="${u.filetype.item}"
						break="${u.filetype.break}"
						fancy="${u.filetype.fancy}"
						minw="${u.filetype.minw}"
						minh="${u.filetype.minh}"

						collink="${u.filetype.collink.columnhyperlink}"
						#if $u.filetype.collink.columnhyperlink == "Y"
						collink_urlcol="${u.filetype.collink.urlcol}"
						collink_urlprefix="${u.filetype.collink.urlprefix}"
						collink_urlsuffix="${u.filetype.collink.urlsuffix}"
						collink_urlitems="${u.filetype.collink.urlitems}"
						#end if
						/>
					#else if $u.filetype.itemtype == "link"
					<link
						obj="${u.filetype.item}"
						break="${u.filetype.break}"
						encoded_id="${__app__.security.encode_id($u.filetype.item.id)}"
						ireport="${u.filetype.ireport}"
						item2="${u.filetype.item2}"
						localhost="${localhost}"
						proxy="${proxy}"
						/>
					#else if $u.filetype.itemtype == "weblink"
					<weblink
						obj="$b64($u.filetype.item)"
						break="${u.filetype.break}"
						item2="$b64($u.filetype.item2)"
						/>
					#else if $u.filetype.itemtype == "text"
					<text
						obj="${u.filetype.item}"
						break="${u.filetype.break}"
						markdown="${u.filetype.md}"
						/>
					#else if $u.filetype.itemtype == "textfile"
					<textfile
						obj="${u.filetype.item}"
						break="${u.filetype.break}"
						markdown="${u.filetype.md}"
						/>
					#else if $u.filetype.itemtype == "htmlfile"
					<htmlfile
						obj="${u.filetype.item}"
						break="${u.filetype.break}"
						height="${u.filetype.height}"
						encoded_id="${__app__.security.encode_id($u.filetype.item.id)}"
						ireport="${u.filetype.ireport}"
						localhost="${localhost}"
						proxy="${proxy}"
						/>
					#else if $u.filetype.itemtype == "htmlpage"
					<htmlpage
						obj="${u.filetype.item}"
						break="${u.filetype.break}"
						height="${u.filetype.height}"
						/>
					#else if $u.filetype.itemtype == "genomebrowser"
					<genomebrowser
						obj="${u.filetype.genomebuild}"
						break="${u.filetype.break}"
						encoded_id="${__app__.security.encode_id($report.id)}"
						localhost="${localhost}"
						initialview="$b64($u.filetype.initialview)">
						#for $k, $gb in enumerate($u.filetype.gbtracks)
						<track item="${gb.item}" label="${gb.tracklabel}" type="${gb.gbfiletype}" />
						#end for
					</genomebrowser>
					#else
					<item
						obj="${u.filetype.item}"
						break="${u.filetype.break}"
						/>
					--item "${t.tabtitle}:${u.filetype.itemtype}:${u.filetype.item}:${u.filetype.break}"
					#end if
				#end for
			</tab>
			#end for
		</iReport>
		]]>
		</configfile>
	</configfiles>

	<inputs>
		<!-- this sucks, but need to hardcode where galaxy is running from for some components -->
		<param name="localhost" type="hidden" value="https://bioinf-galaxian.erasmusmc.nl/galaxy">
			<sanitizer>
				<valid initial="default">
					<add preset="string.printable"/>
					<remove value=":"/>
				</valid>
				<mapping initial="none">
					<add source=":" target="==colon=="/>
				</mapping>
			</sanitizer>
		</param>
		<param name="proxy" type="hidden" value="galaxy"/>
		<!-- /sucks -->


		<param name="label" type="text" size="100" label="Name of Report" >
			<expand macro="sanitizer" />
			<validator type="empty_field" />
		</param>
		<param name="coverimage" type="text" size="100" label="Link to cover image" help="Optional. A default image will be used if not specified">
			<expand macro="sanitizer" />
		</param>

		<param name="minwidth" type="integer" min="0" max="5000" value="1200" label="Width of page (in pixels)" />
		<repeat name="tabs" title="Tab" default="1" >
			<param name="tabtitle" type="text" size="50" label="Enter tab name">
				<expand macro="sanitizer" />
				<validator type="empty_field" />
			</param>
			<repeat name="content" title="Content-Item" default="1">
				<conditional name="filetype">
					<param name="itemtype" type="select" label="Select Item Type" >
						<option value="" > Please choose item type </option>
						<option value="text" > Text Field </option>
						<option value="textfile" > Text File from history </option>
						<option value="htmlfile"> HTML File from history </option>
						<option value="htmlpage"> iFrame with HTML page from web </option>
						<option value="image"> Image </option>
						<option value="pdf"  > PDF File </option>
						<option value="table"> Table </option>
						<option value="link" > Link to Dataset </option>
						<option value="links"> Links to Files in Archive Dataset </option>
						<option value="weblink" > Web link </option>
						<option value="genomebrowser" > Genome Browser (beta) </option>
						<validator type="empty_field" />
					</param>

					<!--###########################
					#       Text Field        #
					########################### -->
					<when value="text">
						<expand macro="md" />
						<param name="item" type="text" area="true" size="10x100" label="Text to display." help="can explicitly add whitespace adding \n in your text for a newline or \t for a tab. HTML tags em, strong, b, i, h1-h6 tags" >
							<expand macro="sanitizer2" />
							<validator type="empty_field" />
						</param>
						<expand macro="break" />
					</when>

					<!--###########################
					#       Text File         #
					########################### -->
					<when value="textfile">
						<expand macro="md" />
						<param name="item" type="data" label="Text File"  help="Text file to display verbatim"/>
						<expand macro="break" />
					</when>

					<!--###########################
					#         HTML File       #
					########################### -->
					<when value="htmlfile">
						<param name="item" type="data" label="HTML File" help="Contents of html file will be displayed in an iframe"/>
						<param name="ireport" type="boolean" checked="False" truevalue="Y" falsevalue="N" label="is the link another iReport?"/>
						<param name="height" type="integer" min="0" max="500000" value="350" label="Height (in pixels)" help="Height of the iFrame displaying the html page"/>
						<expand macro="break" />
					</when>

					<when value="htmlpage">
						<param name="item" type="text" label="URL" size="100" help="Contents of webpage will be displayed in an iframe">
							<expand macro="url_sanitizer" />
						</param>
						<param name="height" type="integer" min="0" max="500000" value="350" label="Height (in pixels)" help="Height of the iFrame displaying the html page"/>
						<expand macro="break" />
					</when>

					<!--###########################
					#          Images         #
					########################### -->
					<when value="image">
						<param name="item" type="data" label="Image File" format="png,svg,jpg,jpeg" help="Supported formats: png, jpg, svg. If image is scaled by choice of width, zoom-on-mousover effect is added."/>
						<param name="zoomlevel" type="integer" min="0" max="5000" value="250" label="Width (in pixels)" help="enter 0 to keep original size" />
						<param name="zoomenable" type="boolean" checked="True" truevalue="Y" falsevalue="N" label="Enable zoom-on-mouseover effect?" help="If checked and nonzero width, zoom-on-mousover effect added"/>
						<param name="align" type="select" label="Alignment of image (float)" help="Use left or right align to have images and text next to each other. Always specify image first (with alignment), then text, if you want to show them side by side." >
							<option value="none"  > default (recommended) </option>
							<option value="left"  > left </option>
							<option value="right" > right </option>
							<option value="middle"> center </option>
							<!--<option value="top"> top </option>
							<option value="bottom"> bottom </option>-->
						</param>
						<expand macro="break" />
					</when>

					<!--###########################
					#          Table          #
					########################### -->
					<when value="table">
						<param name="item" type="data" label="Table File" help="must be a tab-delimited file with a 1-line header" />
						<param name="fancy" type="boolean" checked="True" truevalue="Y" falsevalue="N" label="Fancy table)?" help="If selected, will create, sortable, searchable, paginated table. Otherwise not (for small tables)"/>
						<param name="minw" type="integer" value="0" label="Minimum width of table (in pixels)" help="only needed when tables are not displaying correctly"/>
						<param name="minh" type="integer" value="0" label="Minimum height of table (in pixels)" help="only needed when tables are not displaying correctly"/>
						<conditional name="collink">
							<param name="columnhyperlink" type="select" label="create url links from one of the columns in your table?" help="For example: from column with gene names, link to genecards page">
								<option value="N"> No </option>
								<option value="Y"> Yes </option>
							</param>
							<when value="Y">
								<param name="urlcol"     type="data_column"   data_ref="item" multiple="False" label="Column to turn in to weblinks"  />
								<param name="urlprefix" type="text" size="75" label="URL prefix" help="this will be placed before value in column to form the weblink. e.g. for genecards use: http://www.genecards.org/cgi-bin/carddisp.pl?gene=">
									<sanitizer>
										<valid initial="default">
											<add preset="string.printable"/>
											<remove value="&amp;"/>
											<remove value=":"/>
											<remove value="/"/>
											<remove value=" "/>
											<remove value="~"/>
											<remove value="("/>
											<remove value=")"/>
										</valid>
										<mapping initial="none">
											<add source="&amp;" target="==amp=="/>
											<add source=":" target="==colon=="/>
											<add source="/" target="//"/>
											<add source=" " target=""/>
											<add source="~" target="&amp;#126;"/>
											<add source=")" target="&amp;#41;"/>
											<add source="(" target="&amp;#40;"/>
										</mapping>
									</sanitizer>
								</param>
								<param name="urlsuffix" type="text" size="75" label="URL suffix" help="this will be placed before value in column to form the weblink. e.g. For genecards, there is no suffix">
									<sanitizer>
										<valid initial="default">
											<add preset="string.printable"/>
											<remove value="&amp;"/>
											<remove value="/"/>
											<remove value=" "/>
											<remove value="~"/>
											<remove value="("/>
											<remove value=")"/>
										</valid>
										<mapping initial="none">
											<add source="&amp;" target="&amp;&amp;"/>
											<add source="/" target="//"/>
											<add source=" " target=""/>
											<add source="~" target="&amp;#126;"/>
											<add source=")" target="&amp;#41;"/>
											<add source="(" target="&amp;#40;"/>
										</mapping>
									</sanitizer>
								</param>
								<param name="urlitems" type="data" label="(Not yet implemented) Archive with files to link to" optional="true" help="Optional. Only if you want to link column entries to local files instead of websites" format="data,tar.gz,zip,gz,bz2,tar"/>
							</when>
						</conditional>
						<expand macro="break" />
					</when>

					<!--###########################
					#          PDF File       #
					########################### -->
					<when value="pdf">
						<param name="item" type="data" label="PDF File" format="pdf"/>
						<expand macro="break" />
					</when>

					<!--###########################
					#          Links          #
					########################### -->
					<when value="link">
						<param name="item" type="data" label="File to link to" />
						<param name="item2" type="text" size="100" label="link text" help="text to display as a link"/>
						<param name="ireport" type="boolean" checked="False" truevalue="Y" falsevalue="N" label="is the link another iReport?"/>
						<expand macro="break" />
					</when>

					<when value="links">
						<param name="item" type="data" label="Archive with files to link to" help="links will be created to each file in the archive. Supported formats: zip, gz, tar, bz2"/>
						<expand macro="break" />
					</when>

					<when value="weblink">
						<param name="item"  type="text" size="100" label="web location to link to " help="url to link to">
							<sanitizer>
								<valid initial="default">
									<add preset="string.printable"/>
									<remove value=" "/>
									<remove value="&lt;"/>
									<remove value="&gt;"/>
									<remove value="~"/>
									<remove value="("/>
									<remove value=")"/>
								</valid>
								<mapping initial="none">
									<add source=" " target=""/>
									<add source="&lt;" target="&amp;#60;"/>
									<add source="&gt;" target="&amp;#62;"/>
									<add source=" " target="&amp;#32;"/>
									<add source=")" target="&amp;#41;"/>
									<add source="(" target="&amp;#40;"/>
								</mapping>
							</sanitizer>
						</param>
						<param name="item2" type="text" size="100" label="link text" help="text to display as a link. If left empty, url itself will be the link text">
							<sanitizer>
								<valid initial="default">
									<add preset="string.printable"/>
									<remove value="&lt;"/>
									<remove value="&gt;"/>
									<remove value="~"/>
									<remove value=" "/>
									<remove value="("/>
									<remove value=")"/>
								</valid>
								<mapping initial="none">
									<add source="&lt;" target="&amp;#60;"/>
									<add source="&gt;" target="&amp;#62;"/>
									<add source="~" target="&amp;#126;"/>
									<add source=" " target="&amp;#32;"/>
									<add source=")" target="&amp;#41;"/>
									<add source="(" target="&amp;#40;"/>
								</mapping>
							</sanitizer>
						</param>
						<expand macro="break" />
					</when>

					<!--###########################
					#      Genome Browser     #
					########################### -->
					<when value="genomebrowser">
						<!-- TODO: hardcoded server location needed for dalliance to function correctly! Change as needed! -->

						<param name="genomebuild" type="select" label="Select Genome build to be used for Genome Browser" help="A Bio-Dalliance genome browser will be embedded into your iReport ">
							<option value="hg18"  > hg18 </option>
							<option value="hg19"  > hg19 </option>
						</param>
						<param name="initialview" type="text" size="100" value="1:0-100000" label="Chromosomal location to view when Dalliance starts" help="format: chromosome:start-end, no chr-prefix "/>
						<repeat name="gbtracks" title="Track" default="1" >
							<param name="item" type="data" label="file to display" help="Supported formats: bam, vcf, bed"/>
							<param name="gbfiletype" type="select" label="Select type of file" >
								<option value="vcfmemstore"  > vcf </option>
								<option value="vcftabix"  > vcf (large files) </option>
								<option value="bedmemstore"  > bed </option>
								<option value="bedtabix"  > bed (large files)</option>
								<option value="bam"  > bam (very large files not recommended) </option>
							</param>
							<param name="tracklabel" type="text" size="100" value="mytrack" label="track label" help="give your track a name">
								<sanitizer>
									<valid initial="default">
										<add preset="string.printable"/>
										<remove value=" "/>
										<remove value="("/>
										<remove value=")"/>
									</valid>
									<mapping initial="none">
										<add source=" " target="==space=="/>
										<add source=")" target="==bclose=="/>
										<add source="(" target="==bopen=="/>
									</mapping>
								</sanitizer>
							</param>
						</repeat>
						<expand macro="break" />
					</when>
				</conditional>
			</repeat>
		</repeat>



	</inputs>

	<outputs>
		<data format="html" name="report" label="iReport: ${label}"/>
	</outputs>

	<help>
		============
		iReport
		============

		iReport is a tool for the easy creation of HTML reports from Galaxy datasets. Ideal to use as final step in a pipeline to display all results in a single, interactive report.


		**What's new**

		- MarkDown support
		- HTML content item type
		- Link to download entire iReport on cover page



		**How to use**

		- Specify report title and cover image (url)
		- Add any number of named tabs
		- Add content items to each tab

		1. Text Field
		2. Text File
		3. PDF File
		4. HTML File
		5. Table
		6. Image File
		7. Links (URL/dataset)
		8. Links to all files in an archive dataset

		**Example History**

		http://galaxy-demo.trait-ctmm.cloudlet.sara.nl/u/saskia-hiltemann/h/gcc2014-ireport-about-ireport




	</help>
</tool>
